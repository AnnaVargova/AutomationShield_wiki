#### Contents 
[Introduction](#intro)<br/>
[Application programming interface](#api)<br/>
&nbsp;&nbsp;&nbsp;[C/C++ API](#io)<br/>
&nbsp;&nbsp;&nbsp;[MATLAB API](#matlab)<br/>
&nbsp;&nbsp;&nbsp;[Simulink API](#simulink)<br/>
[Examples](#examples)<br/>
&nbsp;&nbsp;&nbsp;[System identification](#ident)<br/>
&nbsp;&nbsp;&nbsp;[Temperature control](#control)<br/>
[Detailed hardware description](#hardware)<br/>
&nbsp;&nbsp;&nbsp;[Circuit design](#circuit)<br/>
&nbsp;&nbsp;&nbsp;[Parts](#parts)<br/>
&nbsp;&nbsp;&nbsp;[PCB](#pcb)<br/>
[About](#about)<br/>
&nbsp;&nbsp;[Authors](#authors)<br/>


# <a name="intro"/>Introduction

# <a name="api"/>Application programming interface

## <a name="io"/>C/C++ API

### Input

### Output

## <a name="matlab"/>MATLAB API

## <a name="simulink"/>Simulink API

# <a name="examples"/>Examples

## <a name="ident"/>System identification

## <a name="control"/>Feedback control

# <a name="hardware"/>Detailed hardware description

## <a name="circuit"/>Circuit design

## <a name="parts"/>Parts

## <a name="pcb"/>PCB

# <a name="about"/>About
This shield was designed and created as a term project at the Institute of Automation, Measurement and Applied Informatics. The Institute belongs to the Faculty of Mechanical Engineering (FME), Slovak University of Technology in Bratislava in 2017/2018.

## <a name="authors"/>Authors
* 3D-model design: Marcel Vdoleček
* Hardware design: Peter Šálka, Miloš Podbielančík, Dávid Šroba, Martin Lučan
* Software design: Gábor Penzinger, Jakub Kulhánek
* Wiki documentation: Martin Gulan, Gergely Takács


# Introduction

FloatShield is a didactic tool based on the Arduino platform. This project has been created as a part of the [AutomationShield](https://www.automationshield.com) project and is aimed at teaching and learning of control engineering concepts. The FloatShield consists of a translucent vertical tunnel containing a ball that is floating inside via an air current generated by a fan. The goal is to control the position of the ball within this column by the means of a feedback controller.	

The basic design of FloatShield consists of a potentiometer, a distance sensor, a translucent vertical tunnel containing a ball (reference item) that is floating inside and a computer fan attached to our own-design PCB. A transparent tube and a distance sensor is mounted by 3D printed parts.
The function principle is based on controlling the distance of the reference item using the PID feedback controller. Manual control is operated by power regulation of the fan through a potentiometer, which is scaled to a pulse width modulated signal (PWM).

<img width="500" alt="pcbback" src="https://user-images.githubusercontent.com/37963774/39859491-5725bf50-543a-11e8-86ae-32686be9a22b.JPG">


# Library functions

This function needs to be called during setup. It will initiate the sensor.

` void initialize(); `

This function has to be called during setup before initialize. It will print out debug data for the sensor if necessary.

` void debug(); `


This function will return current potentiometer position in percent.

` int referencePercent(); ` 


This function will return current position of the ball as read by the sensor in percent.

` int positionPercent();  ` 


This function will drive the ventilator. Argument of this function is in percent from 0 to 100 - full power.

` void ventInPercent(int value); ` 


Calling this function will switch floatshield into manual control mode. By adjusting the potentiometer ventilator power will adjust accordingly. 

` float manualControl(); `  


This function will return current distance between the sensor and the ball in millimeters.

` int  positionMillimeter(); ` 


This function is recommended to be called during setup. It will run an algorithm, which will adjust minimum and maximum distatnce between the sensor and the ball, so that it corrensponds to 0 and 100% when read.

` void calibrate();`


# Example

## Open-loop control
```
#include <AutomationShield.h>
#include <FloatShield.h>

int dist;


void setup() {
  // FloatShield.debug();     will print out in monitor sensor debug data
  Serial.begin(115200);  //start serial communication
  FloatShield.initialize(); //FloatShield initialization
  FloatShield.calibrate(); //FloatShield calibration for more accurate measurements
}

void loop() {
  FloatShield.manualControl(); //Calling this function will switch floatshield into manual
                               //control mode. By adjusting the potentiometer ventilator power
                               //will adjust accordingly.
  dist = FloatShield.positionMillimeter(); // read sensor 
  Serial.print("Distance (mm): ");
  Serial.println(dist);
}

```
## PID control
```
#include <AutomationShield.h>
#include <FloatShield.h>

int dist;
unsigned long int Ts = 100; //sampling time in ms
bool enable = false; //flag 
int y;  //output
float u; //input
int r; //reference
float Ti,Td,Kp; // PID constants
float error; //error
void setup() {
  Serial.begin(115200); //start serial communication
  FloatShield.initialize(); //FloatShield initialization
  FloatShield.calibrate(); //FloatShield calibration for more accurate measurements
  Sampling.interruptInitialize(Ts*1000); //Sampling initialization in microseconds
  Sampling.setInterruptCallback(StepEnable); // seting the interrupt functon
  //Setting the PID constants
  PIDAbs.setKp(0.86);
  PIDAbs.setKi(1.729);
  PIDAbs.setKd(0.1081);
  //Getting constants needed for calculating PID in absolute form
  Ti = PIDAbs.getTi(); // integral time constant
  Td = PIDAbs.getTd(); // derivative time constant
  Kp = PIDAbs.getKp(); 
}

void loop() 
{
  if(enable)
  {
    Step();
    enable = false; //enable flag becomes false after the execution of the Step() function
  }
}

void StepEnable(void) // interrupt function
{
  enable = true; // when the interrupt function is called, the enable is true
}

void Step (void)
{
  y = FloatShield.positionPercent(); //reading the  sensor value
  r = FloatShield.referencePercent(); //reading the reference value

  error = r - y; 
  u = PIDAbs.compute(error,25,55,0,100); // absolute PID function with anti-wind up and saturation
  FloatShield.ventInPercent(u);
  Serial.print(r);
  Serial.print(", ");
  Serial.print(u);
  Serial.print(", ");
  Serial.println(y);
}

```
 
# Hardware insight 

The Float Shield is an open-source hardware product, dedicated to be widely spread among a control engineering community. Feel free to use any part of it for your own experiments. If you come up with improvements, please let us know so we can improve our design as well. A documentation posted below might help you while working on improvised experimental prototype on breadboard or perforated board. 

## 3D assembly

Firstly, the whole [assembly](https://github.com/gergelytakacs/AutomationShield/files/1942312/assembly.zip) was designed in CAD software and forwarded to 3D print service afterwards. Overall, there are three parts to be printed, a tube clamp, a tube lid and a sensor holder. One might use a honeycomb tube insert to modify turbulent air flow to be way more laminar. Feel free to download ready-to-print [parts](https://github.com/gergelytakacs/AutomationShield/files/1977698/parts.zip). Other assembly parts, a [fan](https://grabcad.com/library/fan-40-x-40-x-28-1) and [Arduino microcontroller](https://grabcad.com/library/arduino-uno-r3-4) are downloadable from GrabCAD database.

<img width="600" alt="FloatShield_parts" src="https://user-images.githubusercontent.com/37963774/39174444-154dc80a-47a8-11e8-9d1e-c78b2c2862db.jpg">

## Circuit design

The circuit schematics has been designed in the Freeware version of the DIPTrace CAD software. You may download the circuit schematics of the FloatShield from [here](https://github.com/gergelytakacs/AutomationShield/files/1934584/Float_scheme.zip).

<img width="1800" alt="floatshield_schemepng" src="https://user-images.githubusercontent.com/37963774/38952961-91a10444-434d-11e8-9ab2-7707e9070782.png">

## Components

| Symbol    	| Part               	| Description                                                     	| Qty. 	| UP    	| Price 	|
|-----------	|--------------------	|-----------------------------------------------------------------	|------	|-------	|-------	|
| (b)       	| PCB                	| FR4, 2 layer, 1.6 mm thick                                      	| 1    	| 0.45  	| 0.45  	|
| (c)       	| Fan                	| Axial, 12 V,  40X40 mm,   24.0 CFM; e.g. Sunon PMD1204PQB1      	| 1    	| 12.61 	| 12.61 	|
| (d)       	| Tube clamp         	| 3D printed, 16 g filament, print time 2:24                      	| 1    	| 0.30  	| 0.30  	|
| (e)       	| Tube               	| Clear, dia 35.5 mm, wall approx. 0.6 mm, 0.4 m; e.g. no. 113816 	| 0.4  	| 10.92 	| 4.37  	|
| (f)       	| Ball               	| Cork, dia 30 mm; e.g. no. 108269                                	| 1    	| 0.63  	| 0.63  	|
| (g)       	| Tube flange        	| 3D printed, 5.8 g filament, print time 57min                    	| 1    	| 0.11  	| 0.11  	|
| (h)       	| Sensor holder      	| 3D printed, 4 g filament, print time 43min                      	| 1    	| 0.08  	| 0.08  	|
| (i)       	| Sensor             	| ST Microelectronics VL5310X TOF sensor on a breakout board      	| 1    	| 5.47  	| 5.47  	|
| (j)       	| Wire               	| 1m, 4 lead, 0.15 mm2,multi-conductor ribbon; e.g. VFL 4x0,14    	| 1    	| 0.28  	| 0.28  	|
| (k)       	| Cable shaft        	| U-shape, 8x330 mm, ASA polymer; e.g.  11796                     	| 1    	| 1.55  	| 1.55  	|
| (l),C1    	| MOSFET             	| IRF520, TO-220AB, e.g. IRF520NPBF                               	| 1    	| 0.41  	| 0.41  	|
| (m), R1   	| Resistor           	| 1 k, 2.5x6.8mm, THT                                             	| 1    	| 0.01  	| 0.01  	|
| (n), R2   	| Resistor           	| 10 k, 2.5x6.8mm, THT                                            	| 1    	| 0.01  	| 0.01  	|
| (o), D1   	| Diode              	| 1N4001, e.g 1N4001-DCO                                          	| 1    	| 0.03  	| 0.03  	|
| (p)       	| Connector (fan)    	| 2x1pin, 0.1" pitch; e.g. e.g. TE Connectivity 280358            	| 1    	| 0.04  	| 0.04  	|
| (p), J2   	| Jumper (fan)       	| 2x1pin, 0.1" pitch; e.g. TE Connectivity 280370-2               	| 1    	| 0.16  	| 0.16  	|
| (q)       	| Connector (sensor) 	| 6x1pin, 0.1" pitch; e.g. TE Connectivity 280360                 	| 1    	| 0.07  	| 0.07  	|
| (q), J1   	| Jumper (sensor)    	| 6x1 pin, 0.1" pitch; e.g. TE Connectivity 280372-2              	| 1    	| 0.36  	| 0.36  	|
| (q),(p)   	| Connector pins     	| e.g.  TE Connectivity   182206-2                                	| 14   	| 0.06  	| 0.90  	|
| (r)       	| Turning knob       	| 5x18.7mm; e.g. ACP 14187-NE                                     	| 1    	| 0.09  	| 0.09  	|
| (r), POT1 	| Potentiometer      	| 10 k                                                            	| 1    	| 0.28  	| 0.28  	|
| (s)       	| Header             	| 10x1 pin, female, long / stackable, 0.1" pitch                  	| 1    	| 0.06  	| 0.06  	|
| (s)       	| Header             	| 8x1 pin, female, long / stackable, 0.1" pitch                   	| 2    	| 0.09  	| 0.18  	|
| (s)       	| Header             	| 6x1 pin, female, long / stackable, 0.1" pitch                   	| 1    	| 0.09  	| 0.09  	|
| -         	| Bolts              	| DIN 912 M3 x 40                                                 	| 4    	| 0.10  	| 0.41  	|
| -         	| Bolts              	| DIN 912 M3 x 16                                                 	| 2    	| 0.04  	| 0.08  	|
| -         	| Nuts               	| DIN 934 M3                                                      	| 6    	| 0.03  	| 0.16  	|
| -         	| Screws             	| DIN 7981F 2.9 x 9.5                                             	| 2    	| 0.03  	| 0.05  	|
| -         	| Washers            	| DIN125 A 3.2 x 7 x 0.5 Polyamide washers                        	| 4    	| 0.01  	| 0.03  	|
| -         	| Standoffs          	| TFM-M3/10                                                       	| 4    	| 0.12  	| 0.46  	|
|    Total: 	|                    	|                                                                 	|      	|       	| 29.72 	|


## PCB layout

The printed circuit board has been designed in the Freeware version of the [DIPTrace](https://diptrace.com/) CAD software. The PCB is two-layer and fits within the customary 100 x 100 mm limit of most board manufacturers. The DIPTrace PCB layout can be downloaded [here](https://github.com/gergelytakacs/AutomationShield/files/1916198/FloatShield_PCB.zip), while the ready-to-manufacture Gerber files with the NC drilling instructions are available from [here](https://github.com/gergelytakacs/AutomationShield/files/1916200/FloatShield_Gerber.zip).

<img width="500" alt="pcbfront" src="https://user-images.githubusercontent.com/37963774/39986438-ef45542e-5761-11e8-8869-8ff14c35a95a.png">
<img width="500" alt="pcbback" src="https://user-images.githubusercontent.com/37963774/39986439-ef812314-5761-11e8-88a9-eab1ce675225.png">

# Photogallery

<img width="500" alt="pcbfront" src="https://user-images.githubusercontent.com/37963774/39666628-d2997bb4-50a6-11e8-922f-b6e33f5e90ac.jpg"/> 

<img width="500" alt="pcbback" src="https://user-images.githubusercontent.com/37963774/39666630-d528035a-50a6-11e8-9020-083c3e945547.jpg"/>

<img width="500" alt="pcbback" src="https://user-images.githubusercontent.com/37963774/39859055-d32716b4-5438-11e8-82a1-a2bf6ed928e7.JPG">

<img width="400" alt="pcbback" src="https://user-images.githubusercontent.com/37963774/39856510-8a0526cc-5430-11e8-8727-c349480db9a3.jpg">

<img width="500" alt="pcbback" src="https://user-images.githubusercontent.com/37963774/39859319-cf669b98-5439-11e8-9d2e-31fc22400bc5.JPG">
